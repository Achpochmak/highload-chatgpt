# ChatGPT

# 1. Тема, MVP, анализ трафика
ChatGPT — это чат-бот на основе нейросети, генерирующий тексты, похожие на написанные человеком

### MVP
1. Регистрация/авторизация
2. Написание и отправка запроса в текстовом формате
3. Отправка изображений
4. Генерация текстового ответа
5. Поиск по истории запросов
6. Просмотр истории запросов

### Анализ трафика
- MAU 180M [1]
- DAU 120M [1]
- Среднее время посещения - 6 минут 14 сек [2]
- В среднем 1 млрд запросов в день [2]
- ~ 10 млн пользователей преимиум подписки [3]


#### Использование ChatGPT по странам
Процент стран по количеству пользователей [[2]]

| Страна    | Количество пользователей, % |
|-----------|:-----------------------------:|
| США     |              14,07              |
| Индия  |              9,5             |
| Бразилия |              4,73              |
| Великобритания       |              3,88              |
| Индонезия |              3,84               |
|   Другие |              63,98               |

Аудитория по возрасту:
- 15% в возрасте 18-29 лет
- 17% в возрасте 30-44 года
- 9% в возрасте 45-64 года
- 5% в возрасте 65+

![image](https://github.com/user-attachments/assets/d21c0384-253e-4a32-9f1b-390b2562cefa)

# 2. Расчет нагрузки

- MAU 180M [1]
- DAU 120M [1]

В чатгпт максимальная длина токенов на вопрос/ответ 4096 для стандартного пользователя, один токен это где-то 4 символа. Возьмем в качестве среднего значения половину от максимального значения - 2048 токенов = 8192 символа. Для пользователя премиум максимум 128 тыс токенов, аналогично возьмем для него половину получим 256 тыс символов в среднем.
В качестве кодировки символов выберем кодировку UTF-8, следовательно, 1 символ весит в среднем 2 байта. Тогда на одного пользователя потребуется: Бесплатный тариф - 16кб байт, платный - 512 кб

Максимум 512 Мб общий размер файлов в диалоге. Возьмем половину от этого значения в качестве среднего размера диалога. Максимум 40-80 запросов к чату в час, поэтому предположим, что на одно сообщение с файлом в среднем приходится 17 Мб, если брать в качестве среднего значения количества сообщений 30 (среднее от половины максимумов). 

Данные необходимые для регистрации:
| Данные    | Длина | Размер | 
|-----------|-----------------------------|-----------|
| Имя     |      25 |        75 байт              |
| Email     |      25 |        75 байт              |
| Пароль     |      10 |        30 байт              |
| Телефон     |      12 |        36 байт              |
| Пароль     |      10 |        30 байт              |
| Страна     |      15 |        45 байт              |

Итого: 291 байт

Средний размер 
| Тип данных     |      Размер на одного пользователя|   
|-----------|-----------------------------|
| Длина запроса и ответа(бесплатная версия)  |      16Кб |      
| Длина запроса и ответа(платная версия)  |      512Кб |     
| Размер загружаемых файлов     |      17Мб |      
| Данные пользователей     |      300 байт |        

RPS среднее 1_000_000_000 / 86400 ≈ 12000 запросов/с
Возьмем пиковую нагрузку в 2 раза больше средней. Также предположим, что 10% пользователей отправляют запросы с файлами. Следовательно (процентное соотношение типов запросов примерное)

| Тип операции     |     Средняя нагрузка |        Пиковая нагрузка             |
|-----------|-----------------------------|-----------|
| Отправка запроса/получение ответа     |      1170 запросов/с |   2340 запросов/с             |
| Отправка запроса/получение ответа с файлом    |      130 запросов/с |   260 запросов/с             |
| Регистрация/авторизация    |      25 запросов/с |        50 запросов/с              |
| Просмотр истории   |      50 запросов/с |        100 запросов/с             |
| Поиск по истории     |      25 запросов/с |        50 запросов/с             |

Рассчитаем разбивку по типам трафика в Гбит/с(при загрузке истории берем, что в среднем пользователь загружает чат, где ~30 сообщений) для бесплатной версии
| Тип операции     |     Средняя нагрузка |        Пиковая нагрузка             |
|-----------|-----------------------------|-----------|
| Отправка запроса/получение ответа     |      18Гбит/с |   36Гбит/с             |
| Отправка запроса/получение ответа  с файлом   |      2Гбит/с |   4Гбит/с             |
| Регистрация/авторизация    |      5*10^(-5)Гбит/с |        1*10^(-4)Гбит/с           |
| Просмотр истории   |       0,36Гбит/с |        0,72Гбит/с            |
| Поиск по истории     |       2*10^(-4)Гбит/с |       4*10^(-4)Гбит/с            |

Рассчитаем разбивку по типам трафика в Гбит/с(при загрузке истории берем, что в среднем пользователь загружает чат, где ~30 сообщений) для платной версии
| Тип операции     |     Средняя нагрузка |        Пиковая нагрузка             |
|-----------|-----------------------------|-----------|
| Отправка запроса/получение ответа     |      10 запросов/с |   20 запросов/с             |
| Отправка запроса/получение ответа с файлом    |      1 запросов/с |   2 запросов/с             |
| Регистрация/авторизация    |      0,2 запросов/с |        0,4 запросов/с              |
| Просмотр истории   |      0,4 запросов/с |        0,8 запросов/с             |
| Поиск по истории     |      0,2 запросов/с |        0,4 запросов/с             |

| Тип операции     |     Средняя нагрузка |        Пиковая нагрузка             |
|-----------|-----------------------------|-----------|
| Отправка запроса/получение ответа     |      4,8Гбит/с |   9,6Гбит/с             |
| Отправка запроса/получение ответа    с файлом |      0,6Гбит/с |   1.2Гбит/с             |
| Регистрация/авторизация    |      5*10^(-7)Гбит/с |        1*10^(-6)Гбит/с           |
| Просмотр истории   |       0,096Гбит/с |        0,192Гбит/с            |
| Поиск по истории     |       2*10^(-6)Гбит/с |       4*10^(-6)Гбит/с            |

# 3. Глобальная балансировка нагрузки
### Домены
openai.com: информация о ее продуктах и исследованиях.  
chat.openai.com: Домен для чат-бота ChatGPT  
chat.com:  домен для упрощения доступа к сервису.  
chatgpt.com: домен для упрощения доступа к сервису.  
ai.com: домен для упрощения доступа к сервису.  
oaistatic.com и oaiusercontent.com: доступ к статическим файлам  

### Расположение доменов
Исходя из процентного расположения пользователей, рекомендуется поставить ЦОДы в США, например, в Вирджинии, где расположены крупные облачные хранилища, в Индии, в Бразилии для покрытия Латинской Америки, в Индонезии для покрытия Юго-Восточной Азии и в Великобритании для покрытия Европы. 

### DNS-балансировка
В качестве алгоритма балансировки рекомендуется использовать алгоритм основанный на геолокации и weighted round robin, который будет учитывать также загруженности сервисов.

Используется балансировка нагрузки и anycast балансировка.


# 5. Логическая схема БД
![image](https://github.com/user-attachments/assets/9d1db344-7a77-4cd9-8fec-d48e0ce4091b)
![image](https://github.com/user-attachments/assets/3c7543cb-97fe-4af1-a1b6-d3e08ab74fd3)

| Таблица |	Размер на пользователя |
|-----------|-----------------------------|
|users | Личные данные пользователей |
| requests | Данные о запросах |
| chats | Данные о чатах |
| user_files |	Данные о загружаемых файлах |
|payments |	Данные об оплате подписки |

Расситаем нагрузку на чтение и запись, возьмем, что примерно 10% пользователей загружают файлы:  

| Таблица |	Размер строки | Количество записей | Общий объем в сутки |
|-----------|-----------------------------|------------|-------------|
| users | 155 байт | 400 млн | 58Тб |
| chats | 36Кб | 3600 млн | 121 Пб |
| requests | 36Кб | 3600 млн | 121 Пб |
| user_files |	240 байт | 12 млн | 28 Гб |
| payments |	57 байт | 300 тыс. | 18 Гб |

Из п.2 возьмем среднее значение файлов 17Мб, поэтому в сутки нужно еще 200Тб в облачном хранилище.

Особенности каждой таблицы:  
Users:
* Шардирование: проводится основываясь на географическом признаке по полю country
* Кеширование: часто запрашиваемые данные(email, subscription) храняться в кеше
* Консистентность: необходима строгая консистентность данных, так как это влияет на бехопасность личных данных пользователя

Requests:
* Шардирование: по user_id
* Кеширование: последние 30 запросов(примерное количество запросов за сутки)
* Консистентность: допустимы задержки

Chats:
* Шардирование: по user_id, чтобы распределить чаты пользователей равномерно по серверам.
* Кеширование: последние активные чаты пользователя могут храниться в кеше для быстрого доступа.
* Консистентность: возможны небольшие задержки при обновлении данных, но порядок сообщений должен сохраняться.

User_files:
* Шардирование: предполагается использование облачного хранилища S3, поэтому шардирование не нужно
* Кеширование: не требуется
* Консистентность: рекомендуется обеспечение строгой консистентности, файлы не должны теряться

Payments:
* Шардирование: по user_id
* Кеширование: нет необходимости
* Консистентность: строгая консистентность, т.к. финансовые данные


# 6. Физическая схема БД
![image](https://github.com/user-attachments/assets/815346b5-d192-4d79-a7bd-189819df3f3b)

### 1. Индексы  
PostgreSQL:
- Users: 
  - email: UNIQUE INDEX (для быстрого поиска и защиты от дубликатов)  
  - phone: UNIQUE INDEX (для быстрого поиска и защиты от дубликатов)  

- Payments:  
  - user_id: B-TREE INDEX (для быстрого поиска платежей по пользователю)  
  - status: B-TREE INDEX (для поиска по статусу)  
  - subscription_till: B-TREE INDEX (для поиска истекающих подписок)  

MongoDB:
- Requests: 
  - created_at: B-TREE-индекс  

- Chats:  
  - user_id: B-TREE INDEX (для поиска чатов конкретного пользователя)  

- Files:
  - request_id: B-TREE INDEX (для связи файлов с запросами)  


### 2. Денормализация
- Users → Payments: храним subscription_till в Users, чтобы не делать JOIN.  



### 3. Выбор СУБД (потаблично)  
| Таблица       | СУБД           | Причины выбора |
|--------------|---------------|----------------|
| Users       | PostgreSQL    | Строгая консистентность, поддержка транзакций, удобные индексы |
| Payments    | PostgreSQL    | ACID-транзакции, работа с финансовыми операциями |
| Requests    | MongoDB       | Высокая нагрузка на запись, JSON-структура, удобство хранения запросов |
| Chats       | MongoDB       | Гибкость, JSON-структура, горизонтальное масштабирование |
| Files       | MongoDB + S3  | Метаданные в MongoDB, файлы в S3 (эффективное хранение) |



### 4. Шардирование и резервирование (потаблично)  

| Таблица      | Шардирование | Репликация / Резервирование |
|-------------|-------------|---------------------------|
| Users       | По `country`  | 2+ реплики |
| Payments    | По `user_id` (PostgreSQL партицирование) | Синхронная репликация |
| Requests    | По `user_id` (MongoDB Sharding) | Реплика-сет на 3+ ноды |
| Chats       | По `user_id` (MongoDB Sharding) | Реплика-сет на 3+ ноды |
| Files       | По `request_id` (MongoDB) | S3 версионирование и бэкапы |



### 6. Балансировка запросов / мультиплексирование подключений  
- PostgreSQL:  
  - PgBouncer для соединений  
  -  Nginx для балансировки нагрузки  

- MongoDB:  
  - MongoDB драйвер автоматически балансирует между шардами  

- S3:  
  - Использование CDN (CloudFront) для скачивания файлов  


### 7. Схема резервного копирования  
PostgreSQL:  
- pg_dump (логический бэкап)  
- pg_basebackup (физический бэкап)  
- Репликация на резервный сервер  

MongoDB:  
- mongodump (логический бэкап)  
- Репликация через Replica Set  
- Snapshots на уровне файловой системы  

S3:  
- Включение версионирования файлов  
- Репликация между регионами

# 8. Технологии 


| Технология            | Область применения         | Мотивация выбора / зачем используется |
|----------------------|----------------------------|----------------------------------------|
| PostgreSQL           | Хранение данных | Надежная реляционная СУБД с поддержкой транзакций и строгой консистентности. Оптимальна для хранения персональных и финансовых данных. Хорошо масштабируется |
| Redis                | Кеширование часто запрашиваемых данных | Быстрый in-memory storage. Позволяет ускорить доступ к часто используемым данным (профили пользователей, активные чаты, сессии). |
| Amazon S3            | Хранение файлов пользователей | Облачное объектное хранилище с высокой доступностью и встроенной репликацией. Отлично подходит для user_files с высокой надежностью хранения. |
| Kafka                | Очереди событий / логирование действий пользователей | Высоконагруженная система доставки сообщений. Позволяет строить event-driven архитектуру и асинхронно обрабатывать действия пользователя. |
| PyTorch / DeepSpeed | Обучение и оптимизация LLM модели | PyTorch как фреймворк обучения ИИ, а DeepSpeed позволяет экономно расходовать память и ускорять обучение больших моделей. |
| HuggingFace Hub      | Хранение и доставка моделей | Платформа для хранения, версионирования и публикации моделей машинного обучения. Упрощает доставку модели в разные окружения. |
| Prometheus + Grafana | Мониторинг состояния сервисов | Сбор и визуализация метрик работы сервисов и инфраструктуры. Позволяет быстро находить узкие места и ошибки. |
| Airflow              | Управление ML Pipeline | Планировщик задач для построения AI пайплайна: загрузка данных, препроцессинг, обучение модели |


# 9. Обеспечение надёжности

Восстановление при сбоях:

| Сценарий сбоя                             | Механизм восстановления                                                  |
|------------------------------------------|--------------------------------------------------------------------------|
| Сбой мастер-ноды PostgreSQL              | Автоматическое переключение на реплику + восстановление WAL       | 
| Сбой ноды AI Pipeline                    | Возобновление DAG в Airflow с последнего чекпоинта                      |
| Потеря модели после обучения             | Используется S3 для хранения всех версий             |
| Недоступность CDN/поставщика S3          | Fallback на локальный MinIO             |
| Проблемы с Redis                         | Подключение к реплике, восстановление из AOF/RDB                        | 
| Массовый сбой в датацентре               | Переключение на бэкап-кластер в другом регионе + DNS failover |


Обеспечение доступности:

| Компонент               |  Обеспечивающие механизмы                             |
|-------------------------|------------------------------------------------------|
| PostgreSQL              | Репликация, автоматический failover, PgBouncer     |
| Redis                   |  Master-Replica, Sentinel                            |
| Kafka                   | Реплики, min.insync.replicas                        |
| S3 / MinIO              |  Версионирование, мульти-региональная репликация     |
| API Gateway / Nginx     |  HA-масштабирование, health-checks                   |
| Модель (HuggingFace)    |  Локальный кэш, версионирование                      |
| Kubernetes              |  Авто-перезапуск, горизонтальное масштабирование     |


***
[1]: https://www.demandsage.com/chatgpt-statistics/
[2]: https://explodingtopics.com/blog/chatgpt-users
[3]: https://increv.co/academy/chatgpt-stats/
[4]: https://aimojo.io/ru/chatgpt-statistics-facts/
[5]: https://itspeaker.ru/news/chislo-polzovateley-chatgpt-uzhe-bolshe-400-mln/
[6]: https://www.kommersant.ru/doc/7517265
